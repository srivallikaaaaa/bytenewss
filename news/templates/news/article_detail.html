{# news/templates/news/article_detail.html #}
{% extends 'website/base.html' %}
{% load static %}
{% get_media_prefix as MEDIA_URL %}

{% block content %}
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="container mt-4">
  <div class="card shadow-lg">
    <div class="card-body">
      <h2 class="card-title">{{ article.title }}</h2>
      <p class="text-muted">
        By {{ article.author }} from {{ article.source }} on {{ article.publication_date|date:"F d, Y" }}
      </p>

      {% if article.summary %}
        <div class="alert alert-primary">
          <strong>Summary:</strong> {{ article.summary|linebreaksbr }}
        </div>

        {# --- Audio Summary Section --- #}
        <div class="mt-3" id="audioPlayerContainer">
          <h5>Audio Summary:</h5>
          {% if article.audio_file %}
            <audio id="audioPlayer" controls preload="auto" style="width: 100%;">
              <source src="{{ MEDIA_URL }}{{ article.audio_file }}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>
            <p class="text-muted small mt-1">File: {{ article.audio_file.name }}</p>
          {% else %}
            <p id="audioStatus" class="text-muted">Audio summary not yet generated.</p>
            <div id="loadingSpinner" class="spinner-border text-primary" role="status" style="display: none;">
              <span class="visually-hidden">Loading...</span>
            </div>
            {% if user.is_authenticated %}
              <button id="generateAudioBtn"
                      class="btn btn-primary btn-sm mt-2"
                      data-article-id="{{ article.pk }}">
                Generate Audio Summary
              </button>
            {% endif %}
          {% endif %}
        </div>
        {# --- End Audio Summary Section --- #}

        <div class="mt-2 text-muted">
          <p>üëç Helpful: {{ helpful_count }} | üëé Not Helpful: {{ not_helpful_count }}</p>
        </div>

        {% if user.is_authenticated %}
          <div>
            <small class="text-muted">Was this summary helpful?</small><br>
            <form id="feedback-form" method="post" action="{% url 'news:submit_summary_feedback' article.id %}">
              {% csrf_token %}
              <input type="hidden" name="is_helpful" id="is-helpful-input" value="">
              <button type="submit" class="btn btn-success" onclick="setFeedbackValue(true)">Yes</button>
              <button type="submit" class="btn btn-danger" onclick="setFeedbackValue(false)">No</button>
            </form>
            <div id="feedback-message" class="text-success mt-2" style="display: none;">Thank you for your feedback!</div>
          </div>

          <script>
            function setFeedbackValue(value) {
              document.getElementById("is-helpful-input").value = value;
            }

            document.getElementById("feedback-form").addEventListener("submit", function (e) {
              e.preventDefault();

              const form = e.target;
              const formData = new FormData(form);
              const csrfToken = formData.get("csrfmiddlewaretoken");

              fetch(form.action, {
                method: "POST",
                headers: {
                  'X-CSRFToken': csrfToken,
                },
                body: formData,
              })
              .then(response => {
                if (response.ok) {
                  document.getElementById("feedback-message").style.display = "block";
                }
              })
              .catch(error => {
                console.error("Error submitting feedback:", error);
              });
            });
          </script>
        {% else %}
          <p class="text-muted mt-2">Login to provide feedback.</p>
        {% endif %}
      {% endif %}

      <p class="card-text mt-4">{{ article.content|linebreaksbr }}</p>

      {% if user.is_authenticated %}
        <form method="post" action="{% url 'news:generate_summary' article.pk %}">
          {% csrf_token %}
          <label for="num_sentences" class="form-label mt-4">Summary Length (number of sentences):</label>
          <input type="number" name="num_sentences" id="num_sentences" min="1" max="10" value="5" class="form-control w-25 d-inline-block">
          <button class="btn btn-outline-info mt-2" type="submit">Generate Summary</button>
        </form>
      {% else %}
        <p class="text-muted mt-3">Login to regenerate summary.</p>
      {% endif %}
    </div>

    <div class="card-footer text-muted text-end">
      Published on {{ article.published_at|date:"F j, Y, g:i a" }}
    </div>
  </div>

  <div class="mt-4">
    <a href="{% url 'news:home' %}" class="btn btn-secondary">‚Üê Back to All Articles</a>
  </div>
</div>

{# --- JavaScript for Audio Generation --- #}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const generateAudioBtn = document.getElementById('generateAudioBtn');
  const audioPlayer = document.getElementById('audioPlayer');
  const audioPlayerContainer = document.getElementById('audioPlayerContainer');
  const audioStatus = document.getElementById('audioStatus');
  const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
  const spinner = document.getElementById('loadingSpinner');

  if (generateAudioBtn) {
    generateAudioBtn.addEventListener('click', function() {
      const articleId = this.dataset.articleId;

      // Show feedback
      audioStatus.textContent = 'Generating audio... Please wait.';
      generateAudioBtn.disabled = true;
      spinner.style.display = 'block';

      fetch(`/news/article/${articleId}/generate_audio_ajax/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json'
        },
      })
      .then(response => {
        spinner.style.display = 'none';
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          audioStatus.textContent = 'Audio summary ready!';
          if (!audioPlayer) {
            const newAudio = document.createElement('audio');
            newAudio.id = 'audioPlayer';
            newAudio.controls = true;
            newAudio.style.width = '100%';

            const source = document.createElement('source');
            source.src = data.audio_url;
            source.type = 'audio/mpeg';

            newAudio.appendChild(source);
            audioPlayerContainer.innerHTML = '';
            audioPlayerContainer.appendChild(newAudio);
            newAudio.load();
            newAudio.play();
          } else {
            audioPlayer.querySelector('source').src = data.audio_url;
            audioPlayer.load();
            audioPlayer.play();
          }
          generateAudioBtn.style.display = 'none';
        } else {
          audioStatus.textContent = `Error: ${data.message}`;
          generateAudioBtn.disabled = false;
        }
      })
      .catch(error => {
        spinner.style.display = 'none';
        audioStatus.textContent = 'Failed to generate audio. Please try again.';
        generateAudioBtn.disabled = false;
        console.error('Fetch error:', error);
      });
    });
  }
});
</script>
{% endblock %}
