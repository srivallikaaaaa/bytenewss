{# news/templates/news/article_detail.html #}
{% extends 'website/base.html' %}
{% load static %}
{% get_media_prefix as MEDIA_URL %}


{% block content %}

<div class="container mt-4">
  <div class="card shadow-lg">
    <div class="card-body">
      <h2 class="card-title">{{ article.title }}</h2>
      <p class="text-muted">
        By {{ article.author }} from {{ article.source }} on {{ article.publication_date|date:"F d, Y" }}
      </p>

      {% if article.summary %}
        <div class="alert alert-primary">
          <strong>Summary:</strong> {{ article.summary|linebreaksbr }}
        </div>

        {% if article.audio_file %}
          <div class="mt-3">
            <h5>Audio Summary:</h5>
            <audio controls preload="auto" style="width: 100%;">
  <source src="{{ MEDIA_URL }}{{ article.audio_file }}" type="audio/mpeg">
  Your browser does not support the audio element.
</audio>


            <p class="text-muted small mt-1">File: {{ article.audio_file.name }}</p>
          </div>
        {% else %}
          <p class="text-muted"><em>No audio summary available.</em></p>
        {% endif %}

        <div class="mt-2 text-muted">
          <p>üëç Helpful: {{ helpful_count }} | üëé Not Helpful: {{ not_helpful_count }}</p>
        </div>

        {% if user.is_authenticated %}
          <div>
            <small class="text-muted">Was this summary helpful?</small><br>
            <form id="feedback-form" method="post" action="{% url 'news:submit_summary_feedback' article.id %}">
              {% csrf_token %}
              <input type="hidden" name="is_helpful" id="is-helpful-input" value="">
              <button type="submit" class="btn btn-success" onclick="setFeedbackValue(true)">Yes</button>
              <button type="submit" class="btn btn-danger" onclick="setFeedbackValue(false)">No</button>
            </form>
            <div id="feedback-message" class="text-success mt-2" style="display: none;">Thank you for your feedback!</div>
          </div>

          <script>
            function setFeedbackValue(value) {
              document.getElementById("is-helpful-input").value = value;
            }

            document.getElementById("feedback-form").addEventListener("submit", function (e) {
              e.preventDefault();

              const form = e.target;
              const formData = new FormData(form);
              const csrfToken = formData.get("csrfmiddlewaretoken");

              fetch(form.action, {
                method: "POST",
                headers: {
                  'X-CSRFToken': csrfToken,
                },
                body: formData,
              })
              .then(response => {
                if (response.ok) {
                  document.getElementById("feedback-message").style.display = "block";
                }
              })
              .catch(error => {
                console.error("Error submitting feedback:", error);
              });
            });
          </script>
        {% else %}
          <p class="text-muted mt-2">Login to provide feedback.</p>
        {% endif %}
      {% endif %}

      <p class="card-text mt-4">{{ article.content|linebreaksbr }}</p>

      {% if user.is_authenticated %}
        <form method="post" action="{% url 'news:generate_summary' article.pk %}">
          {% csrf_token %}
          <label for="num_sentences" class="form-label mt-4">Summary Length (number of sentences):</label>
          <input type="number" name="num_sentences" id="num_sentences" min="1" max="10" value="5" class="form-control w-25 d-inline-block">
          <button class="btn btn-outline-info mt-2" type="submit">Generate Summary</button>
        </form>
      {% else %}
        <p class="text-muted mt-3">Login to regenerate summary.</p>
      {% endif %}
    </div>

    <div class="card-footer text-muted text-end">
      Published on {{ article.published_at|date:"F j, Y, g:i a" }}
    </div>
  </div>

  <div class="mt-4">
    <a href="{% url 'news:home' %}" class="btn btn-secondary">‚Üê Back to All Articles</a>
  </div>
</div>
{% endblock %}